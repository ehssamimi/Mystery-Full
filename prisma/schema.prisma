generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  phone     String    @unique
  role      String    @default("user") // "user" یا "admin"
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  sessions  Session[]
  favorites Favorite[]
  ratings   GameRating[]
}

model VerificationCode {
  id        String   @id @default(cuid())
  phone     String
  code      String   // کد 6 رقمی
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([code])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model Game {
  id          String     @id @default(cuid())
  name        String
  nameEn      String
  description String
  minPlayers  Int
  maxPlayers  Int

  // متن سازگار با نسخه قبلی (برای نمایش سریع و API عمومی)
  category    String
  difficulty  String     @default("medium")
  materials   String?    // مواد مورد نیاز به‌صورت متن آزاد

  rules       String
  tips        String?
  duration    Int        // in minutes
  imageUrl    String?    // URL تصویر از Cloudinary
  isActive    Boolean    @default(true) // فعال/غیرفعال بودن بازی
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // روابط
  favorites   Favorite[]
  ratings     GameRating[]

  // امتیازدهی تجمیعی
  score        Float     @default(5)   // میانگین امتیاز (۱ تا ۵)، مقدار اولیه ۵
  ratingsCount Int       @default(1)   // تعداد رأی‌ها، مقدار اولیه ۱ برای رای پیش‌فرض

  difficultyLevelId String?
  difficultyLevel   DifficultyLevel? @relation(fields: [difficultyLevelId], references: [id], onDelete: SetNull)

  categories    GameCategory[]
  requiredItems GameRequiredItem[]

  gameTypeId String?
  gameType   GameType? @relation(fields: [gameTypeId], references: [id], onDelete: SetNull)
  datasets   GameDataset[]
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  gameId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@index([userId])
  @@index([gameId])
  @@index([createdAt])
}

// سطح دشواری - تنظیمات
model DifficultyLevel {
  id        String   @id @default(cuid())
  nameFa    String
  nameEn    String
  value     String   @unique // easy | medium | hard
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  games Game[]
}

// دسته‌بندی - تنظیمات
model Category {
  id        String          @id @default(cuid())
  nameFa    String
  nameEn    String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  games     GameCategory[]
}

// موارد مورد نیاز - تنظیمات
model RequiredItem {
  id        String             @id @default(cuid())
  nameFa    String
  nameEn    String
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  games     GameRequiredItem[]
}

// نوع بازی - تنظیمات
model GameType {
  id        String   @id @default(cuid())
  nameFa    String
  nameEn    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  games Game[]
}

// Dataset - مجموعه داده‌ها
model Dataset {
  id        String        @id @default(cuid())
  nameFa    String
  nameEn    String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  items     DatasetItem[]
  games     GameDataset[]
}

// DatasetItem - رکوردهای داخل هر Dataset
model DatasetItem {
  id        String   @id @default(cuid())
  datasetId String
  nameFa    String
  nameEn    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dataset   Dataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@index([datasetId])
}

// ارتباط چند-به-چند بازی و دسته‌بندی
model GameCategory {
  id         String   @id @default(cuid())
  gameId     String
  categoryId String

  game       Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([gameId, categoryId])
  @@index([gameId])
  @@index([categoryId])
}

// ارتباط چند-به-چند بازی و موارد مورد نیاز
model GameRequiredItem {
  id             String        @id @default(cuid())
  gameId         String
  requiredItemId String

  game           Game          @relation(fields: [gameId], references: [id], onDelete: Cascade)
  requiredItem   RequiredItem  @relation(fields: [requiredItemId], references: [id], onDelete: Cascade)

  createdAt      DateTime      @default(now())

  @@unique([gameId, requiredItemId])
  @@index([gameId])
  @@index([requiredItemId])
}

// ارتباط چند-به-چند بازی و Dataset
model GameDataset {
  id        String   @id @default(cuid())
  gameId    String
  datasetId String
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  dataset   Dataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([gameId, datasetId])
  @@index([gameId])
  @@index([datasetId])
}

// امتیازدهی کاربران به بازی‌ها
model GameRating {
  id        String   @id @default(cuid())
  gameId    String
  userId    String
  score     Int      // ۱ تا ۵
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([gameId, userId])
  @@index([gameId])
  @@index([userId])
}

